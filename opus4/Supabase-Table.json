-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.analytics_events (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  session_id uuid,
  event_type text NOT NULL,
  event_data jsonb DEFAULT '{}'::jsonb,
  occurred_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT analytics_events_pkey PRIMARY KEY (id),
  CONSTRAINT analytics_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT analytics_events_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.nikigai_sessions(id)
);
CREATE TABLE public.challenge_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  name text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  start_date date DEFAULT CURRENT_DATE,
  CONSTRAINT challenge_groups_pkey PRIMARY KEY (id),
  CONSTRAINT challenge_groups_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.challenge_participants (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  group_id uuid,
  user_id uuid,
  joined_at timestamp with time zone DEFAULT now(),
  CONSTRAINT challenge_participants_pkey PRIMARY KEY (id),
  CONSTRAINT challenge_participants_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.challenge_groups(id),
  CONSTRAINT challenge_participants_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.challenge_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_id text,
  current_day integer DEFAULT 1 CHECK (current_day >= 0 AND current_day <= 7),
  challenge_start_date timestamp with time zone DEFAULT now(),
  last_active_date timestamp with time zone DEFAULT now(),
  total_points integer DEFAULT 0,
  recognise_daily_points integer DEFAULT 0,
  recognise_weekly_points integer DEFAULT 0,
  release_daily_points integer DEFAULT 0,
  release_weekly_points integer DEFAULT 0,
  rewire_daily_points integer DEFAULT 0,
  rewire_weekly_points integer DEFAULT 0,
  reconnect_daily_points integer DEFAULT 0,
  reconnect_weekly_points integer DEFAULT 0,
  essence_boat_unlocked boolean DEFAULT false,
  captains_hat_unlocked boolean DEFAULT false,
  treasure_map_unlocked boolean DEFAULT false,
  sailing_sails_unlocked boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  group_id uuid,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'completed'::text, 'abandoned'::text])),
  challenge_instance_id uuid DEFAULT gen_random_uuid(),
  completed_at timestamp with time zone,
  cutting_anchor_unlocked boolean DEFAULT false,
  CONSTRAINT challenge_progress_pkey PRIMARY KEY (id),
  CONSTRAINT challenge_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT challenge_progress_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.challenge_groups(id)
);
CREATE TABLE public.clustering_metrics (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  session_id uuid NOT NULL,
  user_id uuid NOT NULL,
  step_id text NOT NULL,
  cluster_count integer NOT NULL CHECK (cluster_count > 0),
  overall_score numeric,
  coherence numeric,
  distinctness numeric,
  silhouette numeric,
  balance numeric,
  interpretability numeric,
  grade text CHECK (grade IS NULL OR (grade = ANY (ARRAY['A'::text, 'B'::text, 'C'::text, 'D'::text, 'F'::text]))),
  recommendation text CHECK (recommendation IS NULL OR (recommendation = ANY (ARRAY['present_as_is'::text, 'suggest_review'::text, 'recommend_refinement'::text]))),
  user_refined boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT clustering_metrics_pkey PRIMARY KEY (id),
  CONSTRAINT clustering_metrics_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.nikigai_sessions(id),
  CONSTRAINT clustering_metrics_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.flow_completions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  flow_id text NOT NULL,
  challenge_instance_id uuid,
  completed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT flow_completions_pkey PRIMARY KEY (id),
  CONSTRAINT flow_completions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT fk_flow_challenge FOREIGN KEY (user_id) REFERENCES public.challenge_progress(user_id),
  CONSTRAINT fk_flow_challenge FOREIGN KEY (challenge_instance_id) REFERENCES public.challenge_progress(user_id),
  CONSTRAINT fk_flow_challenge FOREIGN KEY (user_id) REFERENCES public.challenge_progress(challenge_instance_id),
  CONSTRAINT fk_flow_challenge FOREIGN KEY (challenge_instance_id) REFERENCES public.challenge_progress(challenge_instance_id)
);
CREATE TABLE public.healing_compass_responses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  user_name text,
  limiting_impact text,
  selected_safety_contract text,
  past_parallel_story text,
  past_event_emotions text,
  past_event_details text,
  connect_dots_acknowledged text,
  splinter_removal_consent text,
  challenge_enrollment_consent text,
  context jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT healing_compass_responses_pkey PRIMARY KEY (id),
  CONSTRAINT healing_compass_responses_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.lead_flow_profiles (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  user_id uuid,
  session_id text UNIQUE,
  user_name text,
  protective_archetype text,
  protective_confirm text,
  essence_archetype text,
  essence_confirm text,
  persona text,
  email text,
  context jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT lead_flow_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT lead_flow_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.leaderboard_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  rank integer NOT NULL,
  total_points integer NOT NULL,
  leaderboard_type text NOT NULL DEFAULT 'weekly'::text,
  group_id text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT leaderboard_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT leaderboard_snapshots_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.library_display_cache (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL UNIQUE,
  display_data jsonb NOT NULL,
  last_computed_at timestamp with time zone NOT NULL DEFAULT now(),
  cache_version text NOT NULL DEFAULT 'v1'::text,
  is_stale boolean DEFAULT false,
  session_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT library_display_cache_pkey PRIMARY KEY (id),
  CONSTRAINT library_display_cache_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT library_display_cache_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.nikigai_sessions(id)
);
CREATE TABLE public.nervous_system_responses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  created_at timestamp with time zone DEFAULT now(),
  user_id uuid,
  user_email text,
  user_name text,
  impact_goal text,
  income_goal text,
  positive_change text,
  current_struggle text,
  belief_test_results text,
  reflection_text text,
  context jsonb,
  safety_contracts ARRAY,
  CONSTRAINT nervous_system_responses_pkey PRIMARY KEY (id),
  CONSTRAINT nervous_system_responses_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.nikigai_clusters (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  session_id uuid NOT NULL,
  user_id uuid NOT NULL,
  cluster_type text NOT NULL CHECK (cluster_type = ANY (ARRAY['skills'::text, 'problems'::text, 'people'::text, 'persona'::text, 'market'::text, 'roles'::text])),
  cluster_stage text NOT NULL CHECK (cluster_stage = ANY (ARRAY['preview'::text, 'intermediate'::text, 'final'::text])),
  cluster_label text NOT NULL,
  archetype text,
  items jsonb NOT NULL DEFAULT '[]'::jsonb,
  score numeric CHECK (score IS NULL OR score >= 0::numeric AND score <= 1::numeric),
  coherence_score numeric CHECK (coherence_score IS NULL OR coherence_score >= 0::numeric AND coherence_score <= 1::numeric),
  quality_grade text CHECK (quality_grade IS NULL OR (quality_grade = ANY (ARRAY['A'::text, 'B'::text, 'C'::text, 'D'::text, 'F'::text]))),
  user_modified boolean DEFAULT false,
  archived boolean DEFAULT false,
  merged_from ARRAY,
  merged_into uuid,
  split_from uuid,
  split_into ARRAY,
  source_responses jsonb DEFAULT '[]'::jsonb,
  source_tags ARRAY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  insight text,
  CONSTRAINT nikigai_clusters_pkey PRIMARY KEY (id),
  CONSTRAINT nikigai_clusters_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.nikigai_sessions(id),
  CONSTRAINT nikigai_clusters_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.nikigai_key_outcomes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  session_id uuid NOT NULL UNIQUE,
  user_id uuid NOT NULL,
  top_skill_clusters jsonb DEFAULT '[]'::jsonb,
  suggested_job_titles jsonb DEFAULT '[]'::jsonb,
  core_skills ARRAY,
  skill_domains ARRAY,
  top_problem_clusters jsonb DEFAULT '[]'::jsonb,
  change_statements ARRAY,
  industries_aligned ARRAY,
  empathy_snapshot jsonb,
  target_personas ARRAY,
  solution_categories ARRAY,
  opportunity_space jsonb DEFAULT '[]'::jsonb,
  opportunity_statements jsonb DEFAULT '[]'::jsonb,
  mission_statement text,
  vision_in_action text,
  life_story_one_sentence text,
  top_3_future_pulls ARRAY,
  role_models jsonb DEFAULT '[]'::jsonb,
  generated_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT nikigai_key_outcomes_pkey PRIMARY KEY (id),
  CONSTRAINT nikigai_key_outcomes_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.nikigai_sessions(id),
  CONSTRAINT nikigai_key_outcomes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.nikigai_responses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  session_id uuid NOT NULL,
  user_id uuid NOT NULL,
  step_id text NOT NULL,
  step_order_index integer,
  question_text text NOT NULL,
  response_raw text NOT NULL,
  response_structured jsonb,
  bullet_count integer CHECK (bullet_count IS NULL OR bullet_count >= 0),
  tags_extracted jsonb DEFAULT '{}'::jsonb,
  tag_weights jsonb DEFAULT '{}'::jsonb,
  quality_score numeric CHECK (quality_score IS NULL OR quality_score >= 0::numeric AND quality_score <= 1::numeric),
  sparsity_flag boolean DEFAULT false,
  time_to_respond_seconds integer CHECK (time_to_respond_seconds IS NULL OR time_to_respond_seconds >= 0),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  store_as text,
  CONSTRAINT nikigai_responses_pkey PRIMARY KEY (id),
  CONSTRAINT nikigai_responses_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.nikigai_sessions(id),
  CONSTRAINT nikigai_responses_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.nikigai_sessions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  flow_version text NOT NULL DEFAULT 'v2.2'::text,
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  last_step_id text,
  last_active_at timestamp with time zone DEFAULT now(),
  status text NOT NULL DEFAULT 'in_progress'::text CHECK (status = ANY (ARRAY['in_progress'::text, 'completed'::text, 'abandoned'::text])),
  completion_percentage integer DEFAULT 0 CHECK (completion_percentage >= 0 AND completion_percentage <= 100),
  nikigai_path text CHECK (nikigai_path IS NULL OR (nikigai_path = ANY (ARRAY['career'::text, 'entrepreneurial'::text, 'both'::text]))),
  life_map_data jsonb DEFAULT '{}'::jsonb,
  tag_weights jsonb DEFAULT '{}'::jsonb,
  session_metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT nikigai_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT nikigai_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notification_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  daily_quests boolean DEFAULT true,
  leaderboard_updates boolean DEFAULT true,
  group_activity boolean DEFAULT true,
  artifact_unlocks boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  timezone text DEFAULT 'UTC'::text,
  CONSTRAINT notification_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT notification_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.push_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  endpoint text NOT NULL,
  keys jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT push_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT push_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.quest_completions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  quest_id text NOT NULL,
  quest_category text NOT NULL CHECK (quest_category = ANY (ARRAY['Recognise'::text, 'Release'::text, 'Rewire'::text, 'Reconnect'::text, 'Bonus'::text])),
  quest_type text NOT NULL CHECK (quest_type = ANY (ARRAY['daily'::text, 'weekly'::text])),
  points_earned integer NOT NULL,
  reflection_text text,
  completed_at timestamp with time zone DEFAULT now(),
  challenge_day integer NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  challenge_instance_id uuid,
  CONSTRAINT quest_completions_pkey PRIMARY KEY (id),
  CONSTRAINT quest_completions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT quest_completions_instance_fk FOREIGN KEY (user_id) REFERENCES public.challenge_progress(user_id),
  CONSTRAINT quest_completions_instance_fk FOREIGN KEY (challenge_instance_id) REFERENCES public.challenge_progress(user_id),
  CONSTRAINT quest_completions_instance_fk FOREIGN KEY (user_id) REFERENCES public.challenge_progress(challenge_instance_id),
  CONSTRAINT quest_completions_instance_fk FOREIGN KEY (challenge_instance_id) REFERENCES public.challenge_progress(challenge_instance_id)
);
CREATE TABLE public.responses_archived_20251117 (
  id bigint NOT NULL DEFAULT nextval('responses_id_seq'::regclass),
  created_at timestamp with time zone DEFAULT now(),
  session_id text,
  step text,
  user_name text,
  ambition_gap text,
  logical_reasons text,
  past_parallel text,
  splinter_event text,
  post_event_feeling text,
  pre_splinter_identity text,
  splinter_identity text,
  reclaim_consent text,
  protective_archetype text,
  loop_acknowledged text,
  second_half_consent text,
  biology_understanding text,
  essence_archetype text,
  persona_selection text,
  email text,
  flow_version text,
  flow_completed boolean DEFAULT false,
  healing_compass_consent text,
  resource_opt_in text,
  archetype_resources_email text,
  challenge_opt_in text,
  biology_acknowledgement text,
  release_resources_email text,
  closing_acknowledgement text,
  logical_reasons_list text,
  past_parallel_context text,
  splinter_event_description text,
  splinter_identity_verdict text,
  essence_archetype_selection text,
  archetype_acknowledgment text,
  inner_alarm_resources_email text,
  essence_reveal_response text,
  CONSTRAINT responses_archived_20251117_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_feedback (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  finding_flow_feeling text CHECK (finding_flow_feeling = ANY (ARRAY['Excited'::text, 'Curious & open to it'::text, 'Don''t believe in it'::text])),
  essence_initial_feeling text CHECK (essence_initial_feeling = ANY (ARRAY['Excited'::text, 'Curious'::text, 'Bored'::text])),
  essence_accuracy text CHECK (essence_accuracy = ANY (ARRAY['Seen'::text, 'Like it was half right'::text, 'Not 
  really right'::text])),
  protective_impact text CHECK (protective_impact = ANY (ARRAY['Struggling with it lots'::text, 'Occasionally'::text, 'Not at all'::text])),
  portal_navigation text CHECK (portal_navigation = ANY (ARRAY['Super intuitive: Finding the list of challenges for the 4R''s was easy'::text, 'Took me a minute but I got it'::text, 'Super confused, needed to ask for help'::text])),
  portal_feeling text CHECK (portal_feeling = ANY (ARRAY['Excited'::text, 'Curious'::text, 'Overwhelmed'::text])),
  what_loved text,
  recommendation text,
  feature_idea text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_feedback_pkey PRIMARY KEY (id),
  CONSTRAINT user_feedback_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);